{% extends 'base.html' %}
{% block title %}Configure Analysis - {{ filename }}{% endblock %}

{% block head %}
<style>
    /* Styles for the checkbox list */
    #independent-vars-list {
        /* max-height controlled inline or via JS if needed */
        /* border, padding, etc. applied via Bootstrap classes */
    }
    .form-check {
        padding-left: 1.5em; /* Align checkboxes */
        margin-bottom: 0.5rem; /* Space between items */
    }
    .form-check-input {
         margin-left: -1.5em; /* Position checkbox correctly */
         margin-top: 0.25em;
    }
    .form-check-label {
        margin-left: 0.5em; /* Space between checkbox and label */
    }
    /* Style for hidden items if needed (might not be necessary if we just don't render them) */
    /* .form-check.hidden-var { display: none; } */
    #aic_checkbox_div { display: block; }
    
    /* Class to hide model-specific options */
    .model-options-hidden {
        display: none !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-4">
    <h2 class="mb-4 fw-light"><i class="bi bi-sliders me-2"></i>Configure Analysis: {{ filename }}</h2>

    <!-- Data Preview Section (Collapsible) -->
    <div class="accordion mb-4" id="accordionPreview">
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingPreview">
                <button class="accordion-button collapsed bg-light" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePreview" aria-expanded="false" aria-controls="collapsePreview">
                     <h5 class="mb-0 fw-normal"><i class="bi bi-eye me-2"></i>Data Preview (First 5 Rows)</h5>
                </button>
            </h2>
            <div id="collapsePreview" class="accordion-collapse collapse" aria-labelledby="headingPreview" data-bs-parent="#accordionPreview">
                <div class="accordion-body">
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        {{ preview_html | safe }}
                    </div>
                    <small class="text-muted mt-2 d-block">Verify that data and column names were read correctly. Cleaned names used for modeling: {{ columns | join(', ') }}</small>
                </div>
            </div>
        </div>
    </div>
    <!-- End Data Preview -->

    <!-- Model Configuration Form -->
    <div class="card shadow-sm">
        <div class="card-header bg-light">
            <h5 class="mb-0 fw-normal"><i class="bi bi-gear me-2"></i>Model Configuration</h5>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('analyze', filename=filename) }}" id="analysis-form">
                <div class="row g-3 mb-4">
                    <!-- Dependent Variable -->
                    <div class="col-md-6">
                        <label for="dependent_var" class="form-label">Dependent Variable (Y): <span class="text-danger">*</span></label>
                        <select class="form-select choices-select" id="dependent_var" name="dependent_var" required>
                            <option value="">Select Dependent Variable</option>
                            {% for column in columns %}
                                <option value="{{ column }}">{{ column }}</option>
                            {% endfor %}
                        </select>
                         <label for="dep_var_description" class="form-label mt-2">Describe Dependent Variable:</label>
                        <input type="text" class="form-control form-control-sm" id="dep_var_description" name="dep_var_description" placeholder="e.g., Body mass in grams">
                    </div>
                    <!-- Model Type -->
                    <div class="col-md-6">
                        <label for="model_type" class="form-label">Model Type: <span class="text-danger">*</span></label>
                        <select class="form-select choices-select" id="model_type" name="model_type" required>
                            <option value="lm" selected>Linear Model (LM)</option>
                            <option value="glm">Generalized Linear Model (GLM)</option>
                            <option value="lmm">Linear Mixed Model (LMM)</option>
                            <option value="glmm">Generalized Estimating Equations (GEE/GLMM)</option>
                        </select>
                    </div>
                </div>

                 <!-- GLM, LMM, GEE Options ... -->
                 <div id="glm_options" class="mb-3 border p-3 rounded bg-light model-options-hidden">
                     <!-- GLM content -->
                     <h6 class="mb-3"><i class="bi bi-distribute-vertical me-2"></i>GLM Specific Options</h6>
                     <div class="row g-3">
                         <div class="col-md-6">
                            <label for="glm_family" class="form-label">Family:</label>
                            <select class="form-select form-select-sm choices-select-glm" id="glm_family" name="glm_family">
                                <option value="gaussian" selected>Gaussian (Default)</option>
                                <option value="binomial">Binomial</option>
                                <option value="poisson">Poisson</option>
                                <option value="gamma">Gamma</option>
                                <option value="inverse_gaussian">Inverse Gaussian</option>
                            </select>
                         </div>
                         <div class="col-md-6 d-flex align-items-end">
                             <div class="form-check">
                                 <input class="form-check-input" type="checkbox" value="on" id="auto_select_family" name="auto_select_family" checked>
                                 <label class="form-check-label" for="auto_select_family">
                                     Auto-Select Family based on data
                                 </label>
                             </div>
                         </div>
                     </div>
                 </div>
                 <div id="lmm_options" class="mb-3 border p-3 rounded bg-light model-options-hidden">
                      <!-- LMM content -->
                      <h6 class="mb-3"><i class="bi bi-diagram-3 me-2"></i>LMM Specific Options</h6>
                      <div class="mb-3">
                           <label for="grouping_vars" class="form-label">Grouping Variable(s) (for Random Effects): <span class="text-danger">*</span></label>
                           <select class="form-select choices-multiple-lmm" id="grouping_vars" name="grouping_vars" multiple>
                               {# Options populated by JS/Logic - Should be categorical columns #}
                               {% for column in columns %}
                                    {# Add logic later if needed to filter only categorical #}
                                    <option value="{{ column }}">{{ column }}</option>
                               {% endfor %}
                           </select>
                           <small class="text-muted">Select the column(s) defining groups (e.g., Site, Individual).</small>
                      </div>
                 </div>
                 <div id="glmm_options" class="mb-3 border p-3 rounded bg-light model-options-hidden">
                     <!-- GEE content -->
                     <h6 class="mb-3"><i class="bi bi-boxes me-2"></i>GEE/GLMM Specific Options</h6>
                      <div class="row g-3">
                          <div class="col-md-6">
                               <label for="gee_family" class="form-label">Family:</label>
                               <select class="form-select form-select-sm choices-select-gee" id="gee_family" name="gee_family">
                                   <option value="gaussian" selected>Gaussian (Default)</option>
                                   <option value="binomial">Binomial</option>
                                   <option value="poisson">Poisson</option>
                                   <option value="gamma">Gamma</option>
                                   <option value="inverse_gaussian">Inverse Gaussian</option>
                               </select>
                          </div>
                           <div class="col-md-6">
                                <label for="cov_struct" class="form-label">Covariance Structure:</label>
                                <select class="form-select form-select-sm choices-select-gee" id="cov_struct" name="cov_struct">
                                    <option value="independence" selected>Independence</option>
                                    <option value="exchangeable">Exchangeable</option>
                                    <option value="autoregressive">Autoregressive (AR1)</option>
                                </select>
                           </div>
                      </div>
                      <div class="mt-3">
                          <label for="gee_grouping_var" class="form-label">Grouping Variable (Subject ID): <span class="text-danger">*</span></label>
                          <select class="form-select form-select-sm choices-select-gee" id="gee_grouping_var" name="gee_grouping_var">
                               <option value="">Select Grouping Variable</option>
                               {% for column in columns %}
                                   <option value="{{ column }}">{{ column }}</option>
                               {% endfor %}
                          </select>
                           <small class="text-muted">Select the column identifying repeated measurements.</small>
                      </div>
                  </div>

                <!-- Independent Variables (Checkbox List - Rendered by Server) -->
                <div class="mb-3">
                    <label class="form-label">Independent Variable(s) (X): <span class="text-danger">*</span></label>
                    <div id="independent-vars-list" class="border rounded p-2 form-control" style="max-height: 250px; overflow-y: auto; height: auto;">
                        {# Checkboxes generated by Jinja loop directly #}
                        {% if columns %}
                            {% for column in columns %}
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="independent_vars" value="{{ column }}" id="indep_var_{{ loop.index }}">
                                    <label class="form-check-label" for="indep_var_{{ loop.index }}">
                                        {{ column }}
                                    </label>
                                </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-danger">Error: Column list not available.</p>
                        {% endif %}
                    </div>
                     {# Keep hidden input for basic HTML5 required validation, though JS validation is removed #}
                     <input type="hidden" id="independent_vars_hidden_required" name="independent_vars_placeholder" required>
                     <div id="independent_vars_error" class="invalid-feedback" style="display: none;">Please select at least one independent variable.</div>
                    <small class="text-muted">Check the variables to include as predictors. (Note: Dependent variable is NOT automatically filtered in this view).</small>
                </div>

                <!-- Simple Textarea for Predictor Descriptions -->
                <div class="mb-3">
                    <label for="predictors_description_text" class="form-label">Describe Predictors (Optional):</label>
                    <textarea class="form-control form-control-sm" id="predictors_description_text" name="predictors_description_text" rows="3" placeholder="Describe each selected predictor, e.g.,&#10;MASS: Body mass (g)&#10;SOIL: Soil type (categorical)"></textarea>
                    <small class="text-muted">Provide units or context for selected predictors (one per line helps).</small>
                </div>

                <!-- Model Selection Option -->
                {# JS will control disabled state #}
                <div class="form-check mb-3" id="aic_checkbox_div">
                    <input class="form-check-input" type="checkbox" value="on" id="perform_aic" name="perform_aic">
                    <label class="form-check-label" for="perform_aic">
                        Perform Model Selection using AIC/QIC (Backward Elimination)
                    </label>
                     <small class="text-muted d-block">Requires >1 predictor selected.</small>
                 </div>

                <!-- AI Interpretation API Key (Optional) -->
                 <div class="mb-3">
                    <label for="hf_api_token" class="form-label">Hugging Face API Token (Optional):</label>
                    <input type="password" class="form-control form-control-sm" id="hf_api_token" name="hf_api_token" placeholder="Enter token for AI interpretation">
                    <small class="text-muted">Needed only if you want AI-generated interpretation.</small>
                 </div>

                <button type="submit" class="btn btn-primary w-100"><i class="bi bi-play-circle me-2"></i>Run Analysis</button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log("DOM Loaded. Initializing AIC checkbox script...");

    const independentVarsListDiv = document.getElementById('independent-vars-list');
    const aicCheckbox = document.getElementById('perform_aic');
    // Removed references to varDescContainer and dynamicInputsContainer

    if (!independentVarsListDiv || !aicCheckbox) { // Simplified check
        console.error("CRITICAL: Could not find essential elements ('independent-vars-list' or 'perform_aic'). Script aborted.");
        return;
    }

    // Function to update AIC checkbox state based on selection
    function updateAICCheckboxState() {
        const checkedBoxes = independentVarsListDiv.querySelectorAll('input[type="checkbox"][name="independent_vars"]:checked');
        const checkedCount = checkedBoxes.length;

        console.log(`Updating AIC checkbox state. ${checkedCount} predictors selected.`);

        aicCheckbox.disabled = checkedCount <= 1;
        if (aicCheckbox.disabled) {
            aicCheckbox.checked = false; // Uncheck if disabled
        }
        console.log(`AIC Checkbox disabled: ${aicCheckbox.disabled}`);
    }

    // Event Listener for checkbox changes
    independentVarsListDiv.addEventListener('change', (event) => {
        if (event.target.type === 'checkbox' && event.target.name === 'independent_vars') {
            console.log(`Checkbox change detected for: ${event.target.value}`);
            updateAICCheckboxState(); // Only update AIC state now
        }
    });

    // Initial call to set the AIC state when the page loads
    console.log("Running initial AIC checkbox update...");
    updateAICCheckboxState();
    console.log("AIC checkbox script initialization complete.");
    
    // --- Initialize Choices.js for Selects ---
    console.log("Initializing Choices.js for all relevant selects...");
    let choicesInstances = {}; // Store instances if needed later
    
    // Initialize standard single selects
    document.querySelectorAll('.choices-select').forEach(el => {
        try {
            choicesInstances[el.id] = new Choices(el, { searchEnabled: true, itemSelectText: '', shouldSort: false, allowHTML: false });
        } catch (e) { console.error(`Error initializing Choices for #${el.id}:`, e); }
    });
    
    // Initialize selects within GLM options
    document.querySelectorAll('.choices-select-glm').forEach(el => {
        try {
            choicesInstances[el.id] = new Choices(el, { searchEnabled: false, itemSelectText: '', shouldSort: false, allowHTML: false }); // Disable search for family?
        } catch (e) { console.error(`Error initializing Choices for #${el.id}:`, e); }
    });

    // Initialize selects within LMM options (multi-select example)
     document.querySelectorAll('.choices-multiple-lmm').forEach(el => {
         try {
             choicesInstances[el.id] = new Choices(el, { removeItemButton: true, searchEnabled: true, shouldSort: false, allowHTML: false });
         } catch (e) { console.error(`Error initializing Choices for #${el.id}:`, e); }
     });
     
    // Initialize selects within GEE options
    document.querySelectorAll('.choices-select-gee').forEach(el => {
        try {
            choicesInstances[el.id] = new Choices(el, { searchEnabled: true, itemSelectText: '', shouldSort: false, allowHTML: false });
        } catch (e) { console.error(`Error initializing Choices for #${el.id}:`, e); }
    });
    console.log("Choices.js initialization attempted for all selects.");

    // --- Logic for Model Specific Options --- 
    const modelTypeSelect = document.getElementById('model_type');
    const glmOptionsDiv = document.getElementById('glm_options');
    const lmmOptionsDiv = document.getElementById('lmm_options');
    const glmmOptionsDiv = document.getElementById('glmm_options');
    
    if (!modelTypeSelect || !glmOptionsDiv || !lmmOptionsDiv || !glmmOptionsDiv) {
        console.error("CRITICAL: Could not find model type select or options divs. Model specific options will not work.");
        return;
    }

    function toggleModelOptions() {
        // alert("DEBUG: toggleModelOptions() called!"); // Removed alert
        const selectedType = modelTypeSelect.value;
        console.log(`Model type changed to: ${selectedType}. Toggling options using CSS classes...`);
        
        // Add hidden class to all options divs first
        glmOptionsDiv.classList.add('model-options-hidden');
        lmmOptionsDiv.classList.add('model-options-hidden');
        glmmOptionsDiv.classList.add('model-options-hidden');
        
        // Remove hidden class from the relevant one
        if (selectedType === 'glm') {
            // alert("DEBUG: Model type is GLM, removing hidden class..."); // Removed alert
            glmOptionsDiv.classList.remove('model-options-hidden');
            console.log("Removed model-options-hidden from #glm_options");
        } else if (selectedType === 'lmm') {
             // alert("DEBUG: Model type is LMM, removing hidden class..."); // Removed alert
            lmmOptionsDiv.classList.remove('model-options-hidden');
            console.log("Removed model-options-hidden from #lmm_options");
        } else if (selectedType === 'glmm') {
             // alert("DEBUG: Model type is GLMM, removing hidden class..."); // Removed alert
            glmmOptionsDiv.classList.remove('model-options-hidden');
             console.log("Removed model-options-hidden from #glmm_options");
        } else {
             // alert("DEBUG: Model type is LM or other, ensuring all hidden."); // Removed alert
             console.log("Model type is LM or other, all options remain hidden.");
        }
    }
    
    // Event listener for model type change
    modelTypeSelect.addEventListener('change', toggleModelOptions);
    
    // Initial call to set the correct options visibility on page load
    console.log("Running initial model options toggle...");
    toggleModelOptions();
    console.log("Model options script initialization complete.");

}); // End DOMContentLoaded
</script>
{% endblock %}