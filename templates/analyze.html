{% extends 'base.html' %}
{% block title %}Configure Analysis - {{ filename }}{% endblock %}

{% block head %}
<style>
    /* Styles for the checkbox list */
    #independent-vars-list {
        /* max-height controlled inline or via JS if needed */
        /* border, padding, etc. applied via Bootstrap classes */
    }
    .form-check {
        padding-left: 1.5em; /* Align checkboxes */
        margin-bottom: 0.5rem; /* Space between items */
    }
    .form-check-input {
         margin-left: -1.5em; /* Position checkbox correctly */
         margin-top: 0.25em;
    }
    .form-check-label {
        margin-left: 0.5em; /* Space between checkbox and label */
    }
    /* Style for hidden items if needed (might not be necessary if we just don't render them) */
    /* .form-check.hidden-var { display: none; } */
    #aic_checkbox_div { display: block; }
</style>
{% endblock %}

{% block content %}
<div class="container my-4">
    <h2 class="mb-4 fw-light"><i class="bi bi-sliders me-2"></i>Configure Analysis: {{ filename }}</h2>

    <!-- Data Preview Section (Collapsible) -->
    <div class="accordion mb-4" id="accordionPreview">
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingPreview">
                <button class="accordion-button collapsed bg-light" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePreview" aria-expanded="false" aria-controls="collapsePreview">
                     <h5 class="mb-0 fw-normal"><i class="bi bi-eye me-2"></i>Data Preview (First 5 Rows)</h5>
                </button>
            </h2>
            <div id="collapsePreview" class="accordion-collapse collapse" aria-labelledby="headingPreview" data-bs-parent="#accordionPreview">
                <div class="accordion-body">
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        {{ preview_html | safe }}
                    </div>
                    <small class="text-muted mt-2 d-block">Verify that data and column names were read correctly. Cleaned names used for modeling: {{ columns | join(', ') }}</small>
                </div>
            </div>
        </div>
    </div>
    <!-- End Data Preview -->

    <!-- Model Configuration Form -->
    <div class="card shadow-sm">
        <div class="card-header bg-light">
            <h5 class="mb-0 fw-normal"><i class="bi bi-gear me-2"></i>Model Configuration</h5>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('analyze', filename=filename) }}" id="analysis-form">
                <div class="row g-3 mb-4">
                    <!-- Dependent Variable -->
                    <div class="col-md-6">
                        <label for="dependent_var" class="form-label">Dependent Variable (Y): <span class="text-danger">*</span></label>
                        <select class="form-select choices-select" id="dependent_var" name="dependent_var" required>
                            <option value="">Select Dependent Variable</option>
                            {% for column in columns %}
                                <option value="{{ column }}">{{ column }}</option>
                            {% endfor %}
                        </select>
                         <label for="dep_var_description" class="form-label mt-2">Describe Dependent Variable:</label>
                        <input type="text" class="form-control form-control-sm" id="dep_var_description" name="dep_var_description" placeholder="e.g., Body mass in grams">
                    </div>
                    <!-- Model Type -->
                    <div class="col-md-6">
                        <label for="model_type" class="form-label">Model Type: <span class="text-danger">*</span></label>
                        <select class="form-select choices-select" id="model_type" name="model_type" required>
                            <option value="lm" selected>Linear Model (LM)</option>
                            <option value="glm">Generalized Linear Model (GLM)</option>
                            <option value="lmm">Linear Mixed Model (LMM)</option>
                            <option value="glmm">Generalized Estimating Equations (GEE/GLMM)</option>
                        </select>
                    </div>
                </div>

                 <!-- GLM Specific Options (Initially Hidden) -->
                <div id="glm_options" class="mb-3 border p-3 rounded bg-light" style="display: none;">
                    <h6>GLM Options</h6>
                     <label for="glm_family" class="form-label">Family:</label>
                    <select class="form-select form-select-sm choices-select" id="glm_family" name="glm_family">
                        <option value="auto" selected>Auto-Detect</option>
                        <option value="gaussian">Gaussian (Normal)</option>
                        <option value="binomial">Binomial (Logit)</option>
                        <option value="poisson">Poisson (Log)</option>
                        <option value="gamma">Gamma (Inverse)</option>
                        <option value="inverse_gaussian">Inverse Gaussian (1/mu^2)</option>
                        <!-- Add other families as needed -->
                    </select>
                </div>

                <!-- LMM Specific Options (Initially Hidden) -->
                <div id="lmm_options" class="mb-3 border p-3 rounded bg-light" style="display: none;">
                     <h6>LMM Options</h6>
                    <label for="grouping_vars" class="form-label" id="grouping_vars_label">Grouping Variable(s) (Random Effects):</label>
                    <select class="form-select choices-multiple" id="grouping_vars" name="grouping_vars" multiple>
                         {% for column in columns %}
                            <option value="{{ column }}">{{ column }}</option>
                        {% endfor %}
                    </select>
                    <small class="text-muted">Select the column(s) identifying groups/clusters.</small>
                </div>

                 <!-- GEE Specific Options (Initially Hidden) -->
                <div id="glmm_options" class="mb-3 border p-3 rounded bg-light" style="display: none;">
                    <h6>GEE (GLMM) Options</h6>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="gee_family" class="form-label">Family:</label>
                            <select class="form-select form-select-sm choices-select" id="gee_family" name="gee_family">
                                <option value="auto" selected>Auto-Detect</option>
                                <option value="gaussian">Gaussian</option>
                                <option value="binomial">Binomial</option>
                                <option value="poisson">Poisson</option>
                                <option value="gamma">Gamma</option>
                                <option value="inverse_gaussian">Inverse Gaussian</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="group_id_var" class="form-label" id="group_id_var_label">Group ID Variable:</label>
                            <select class="form-select form-select-sm choices-select" id="group_id_var" name="group_id_var">
                                <option value="">Select Group ID</option>
                                {% for column in columns %}
                                    <option value="{{ column }}">{{ column }}</option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">Column identifying independent groups.</small>
                        </div>
                        <div class="col-md-4">
                             <label for="cov_struct" class="form-label">Covariance Structure:</label>
                            <select class="form-select form-select-sm choices-select" id="cov_struct" name="cov_struct">
                                <option value="exchangeable" selected>Exchangeable</option>
                                <option value="independence">Independence</option>
                                <option value="autoregressive">Autoregressive (AR-1)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Independent Variables (Checkbox List - Rendered by Server) -->
                <div class="mb-3">
                    <label class="form-label">Independent Variable(s) (X): <span class="text-danger">*</span></label>
                    <div id="independent-vars-list" class="border rounded p-2 form-control" style="max-height: 250px; overflow-y: auto; height: auto;">
                        {# Checkboxes generated by Jinja loop directly #}
                        {% if columns %}
                            {% for column in columns %}
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="independent_vars" value="{{ column }}" id="indep_var_{{ loop.index }}">
                                    <label class="form-check-label" for="indep_var_{{ loop.index }}">
                                        {{ column }}
                                    </label>
                                </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-danger">Error: Column list not available.</p>
                        {% endif %}
                    </div>
                     {# Keep hidden input for basic HTML5 required validation, though JS validation is removed #}
                     <input type="hidden" id="independent_vars_hidden_required" name="independent_vars_placeholder" required>
                     <div id="independent_vars_error" class="invalid-feedback" style="display: none;">Please select at least one independent variable.</div>
                    <small class="text-muted">Check the variables to include as predictors. (Note: Dependent variable is NOT automatically filtered in this view).</small>
                </div>

                <!-- Simple Textarea for Predictor Descriptions -->
                <div class="mb-3">
                    <label for="predictors_description_text" class="form-label">Describe Predictors (Optional):</label>
                    <textarea class="form-control form-control-sm" id="predictors_description_text" name="predictors_description_text" rows="3" placeholder="Describe each selected predictor, e.g.,&#10;MASS: Body mass (g)&#10;SOIL: Soil type (categorical)"></textarea>
                    <small class="text-muted">Provide units or context for selected predictors (one per line helps).</small>
                </div>

                <!-- Model Selection Option -->
                {# JS will control disabled state #}
                <div class="form-check mb-3" id="aic_checkbox_div">
                    <input class="form-check-input" type="checkbox" value="on" id="perform_aic" name="perform_aic">
                    <label class="form-check-label" for="perform_aic">
                        Perform Model Selection using AIC/QIC (Backward Elimination)
                    </label>
                     <small class="text-muted d-block">Requires >1 predictor selected.</small>
                 </div>

                <!-- AI Interpretation API Key (Optional) -->
                 <div class="mb-3">
                    <label for="hf_api_token" class="form-label">Hugging Face API Token (Optional):</label>
                    <input type="password" class="form-control form-control-sm" id="hf_api_token" name="hf_api_token" placeholder="Enter token for AI interpretation">
                    <small class="text-muted">Needed only if you want AI-generated interpretation.</small>
                 </div>

                <button type="submit" class="btn btn-primary w-100"><i class="bi bi-play-circle me-2"></i>Run Analysis</button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log("DOM Loaded. Initializing AIC checkbox script...");

    const independentVarsListDiv = document.getElementById('independent-vars-list');
    const aicCheckbox = document.getElementById('perform_aic');
    // Removed references to varDescContainer and dynamicInputsContainer

    if (!independentVarsListDiv || !aicCheckbox) { // Simplified check
        console.error("CRITICAL: Could not find essential elements ('independent-vars-list' or 'perform_aic'). Script aborted.");
        return;
    }

    // Function to update AIC checkbox state based on selection
    function updateAICCheckboxState() {
        const checkedBoxes = independentVarsListDiv.querySelectorAll('input[type="checkbox"][name="independent_vars"]:checked');
        const checkedCount = checkedBoxes.length;

        console.log(`Updating AIC checkbox state. ${checkedCount} predictors selected.`);

        aicCheckbox.disabled = checkedCount <= 1;
        if (aicCheckbox.disabled) {
            aicCheckbox.checked = false; // Uncheck if disabled
        }
        console.log(`AIC Checkbox disabled: ${aicCheckbox.disabled}`);
    }

    // Event Listener for checkbox changes
    independentVarsListDiv.addEventListener('change', (event) => {
        if (event.target.type === 'checkbox' && event.target.name === 'independent_vars') {
            console.log(`Checkbox change detected for: ${event.target.value}`);
            updateAICCheckboxState(); // Only update AIC state now
        }
    });

    // Initial call to set the AIC state when the page loads
    console.log("Running initial AIC checkbox update...");
    updateAICCheckboxState();
    console.log("AIC checkbox script initialization complete.");

}); // End DOMContentLoaded
</script>
{% endblock %}